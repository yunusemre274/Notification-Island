<UserControl x:Class="NI.App.Views.DynamicIslandView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="clr-namespace:NI.App.ViewModels"
             Width="700" Height="42"
             MouseLeftButtonDown="OnLeftClick"
             MouseRightButtonDown="OnRightClick">

    <UserControl.DataContext>
        <vm:IslandVM />
    </UserControl.DataContext>

    <UserControl.RenderTransform>
        <TransformGroup>
            <ScaleTransform x:Name="IslandScale" ScaleX="1" ScaleY="1" CenterX="350" CenterY="21"/>
            <TranslateTransform x:Name="IslandSlide" Y="-50"/>
        </TransformGroup>
    </UserControl.RenderTransform>

    <UserControl.Resources>
        <!-- Frozen brushes for performance -->
        <SolidColorBrush x:Key="IslandBg" Color="#000000" Opacity="0.85"/>
        
        <!-- Expand animation -->
        <Storyboard x:Key="ExpandAnim">
            <DoubleAnimation Storyboard.TargetName="IslandBorder" Storyboard.TargetProperty="Width"
                             To="700" Duration="0:0:0.25">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetName="IslandBorder" Storyboard.TargetProperty="Height"
                             To="42" Duration="0:0:0.25">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetName="ExpandedContent" Storyboard.TargetProperty="Opacity"
                             To="1" Duration="0:0:0.2" BeginTime="0:0:0.1"/>
        </Storyboard>

        <!-- Compact animation -->
        <Storyboard x:Key="CompactAnim">
            <DoubleAnimation Storyboard.TargetName="IslandBorder" Storyboard.TargetProperty="Width"
                             To="180" Duration="0:0:0.25">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetName="IslandBorder" Storyboard.TargetProperty="Height"
                             To="36" Duration="0:0:0.25">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetName="ExpandedContent" Storyboard.TargetProperty="Opacity"
                             To="0" Duration="0:0:0.15"/>
        </Storyboard>

        <!-- Pulse animation for click feedback -->
        <Storyboard x:Key="PulseAnim">
            <DoubleAnimation Storyboard.TargetName="IslandScale" Storyboard.TargetProperty="ScaleX"
                             To="1.03" Duration="0:0:0.1" AutoReverse="True"/>
            <DoubleAnimation Storyboard.TargetName="IslandScale" Storyboard.TargetProperty="ScaleY"
                             To="1.03" Duration="0:0:0.1" AutoReverse="True"/>
        </Storyboard>

        <!-- Entrance animation -->
        <Storyboard x:Key="EnterAnim">
            <DoubleAnimation Storyboard.TargetName="IslandSlide" Storyboard.TargetProperty="Y"
                             From="-50" To="0" Duration="0:0:0.35">
                <DoubleAnimation.EasingFunction>
                    <CubicEase EasingMode="EaseOut"/>
                </DoubleAnimation.EasingFunction>
            </DoubleAnimation>
            <DoubleAnimation Storyboard.TargetProperty="Opacity"
                             From="0" To="1" Duration="0:0:0.3"/>
        </Storyboard>
    </UserControl.Resources>

    <UserControl.Triggers>
        <EventTrigger RoutedEvent="Loaded">
            <BeginStoryboard Storyboard="{StaticResource EnterAnim}"/>
        </EventTrigger>
    </UserControl.Triggers>

    <Grid>
        <!-- Main Island Border -->
        <Border x:Name="IslandBorder" 
                Width="180" Height="36"
                CornerRadius="21"
                Background="{StaticResource IslandBg}"
                HorizontalAlignment="Center" VerticalAlignment="Center">
            
            <Grid>
                <!-- Compact Content (always visible) -->
                <StackPanel x:Name="CompactContent" Orientation="Horizontal" 
                            HorizontalAlignment="Center" VerticalAlignment="Center">
                    
                    <!-- App Icon (small) -->
                    <Image x:Name="AppIcon" Width="22" Height="22" 
                           Source="{Binding CurrentIcon}" Margin="0,0,8,0"/>
                    
                    <!-- Clock -->
                    <TextBlock Text="{Binding ClockText}" 
                               FontFamily="Segoe UI Semibold" FontSize="14" 
                               Foreground="White" VerticalAlignment="Center"/>
                    
                    <!-- Status dot -->
                    <Ellipse Width="8" Height="8" Fill="#2EE36E" 
                             VerticalAlignment="Center" Margin="8,0,0,0"/>
                    
                    <!-- Pet (compact) -->
                    <Image x:Name="PetSprite" Width="28" Height="28"
                           Source="{Binding PetFrame}" Margin="8,0,0,0"
                           RenderTransformOrigin="0.5,1">
                        <Image.RenderTransform>
                            <TransformGroup>
                                <ScaleTransform x:Name="PetScale" ScaleX="1" ScaleY="1"/>
                                <TranslateTransform x:Name="PetBounce" Y="0"/>
                            </TransformGroup>
                        </Image.RenderTransform>
                    </Image>
                </StackPanel>

                <!-- Expanded Content (fades in/out) -->
                <Grid x:Name="ExpandedContent" Opacity="0" Margin="16,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <!-- Left: Icon + Clock -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                        <Image Width="26" Height="26" Source="{Binding CurrentIcon}" Margin="0,0,10,0"/>
                        <TextBlock Text="{Binding ClockText}" FontFamily="Segoe UI Semibold" 
                                   FontSize="15" Foreground="White" VerticalAlignment="Center"/>
                        <Ellipse Width="8" Height="8" Fill="#2EE36E" 
                                 VerticalAlignment="Center" Margin="10,0,0,0"/>
                    </StackPanel>

                    <!-- Center: Notification -->
                    <StackPanel Grid.Column="1" VerticalAlignment="Center" 
                                HorizontalAlignment="Center" Margin="20,0">
                        <TextBlock Text="{Binding AppName}" FontWeight="SemiBold" 
                                   Foreground="White" FontSize="13" TextTrimming="CharacterEllipsis"/>
                        <TextBlock Text="{Binding NotificationText}" 
                                   Foreground="#AAFFFFFF" FontSize="12" TextTrimming="CharacterEllipsis"/>
                    </StackPanel>

                    <!-- Right: Pet -->
                    <Image Grid.Column="2" Width="32" Height="32"
                           Source="{Binding PetFrame}" VerticalAlignment="Center"/>
                </Grid>
            </Grid>
        </Border>

        <!-- Settings Popup -->
        <Popup x:Name="SettingsPopup" Placement="Bottom" StaysOpen="False"
               AllowsTransparency="True" PopupAnimation="Fade">
            <Border Background="#E8000000" CornerRadius="12" Padding="12" Margin="8">
                <StackPanel Width="160">
                    <TextBlock Text="Settings" Foreground="White" FontWeight="Bold" 
                               FontSize="13" Margin="0,0,0,10"/>
                    <CheckBox Content="Autostart" Foreground="White" FontSize="12"
                              IsChecked="{Binding AutostartEnabled}" Margin="0,4"/>
                    <CheckBox Content="Sound" Foreground="White" FontSize="12"
                              IsChecked="{Binding SoundEnabled}" Margin="0,4"/>
                    <CheckBox Content="Show Pet" Foreground="White" FontSize="12"
                              IsChecked="{Binding PetEnabled}" Margin="0,4"/>
                    <Separator Margin="0,8" Background="#333"/>
                    <Button Content="Quit" Click="OnQuit" 
                            Background="#FF4444" Foreground="White" 
                            BorderThickness="0" Padding="8,4" Cursor="Hand"/>
                </StackPanel>
            </Border>
        </Popup>
    </Grid>
</UserControl>
